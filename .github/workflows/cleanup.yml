name: Clean Up

on:
  schedule:
    - cron: '0 0 * * 0'  # Run at 00:00 on Sunday.
  pull_request:
    # types: [closed]
    branches: [ "main" ] #TODO: Debug: Remove

jobs:
  delete-package-versions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: List All Packages and Delete Versions
        uses: actions/github-script@v7
        with:
          script: |
            const org = context.repo.owner;
            const repo = context.repo.repo;

            // Fetch all packages in the repository
            const packagesResponse = await github.rest.packages.getAllPackageVersionsForRepo({
              owner: org,
              repo: repo
            });

            // Fetch closed PRs
            const closedPrsResponse = await github.rest.pulls.list({
              owner: org,
              repo: repo,
              state: 'closed'
            });
            const closedPrNumbers = closedPrsResponse.data.map(pr => pr.number);

            for (const package of packagesResponse.data) {
              const packageName = package.name;
              const packageType = package.package_type;

              // Fetch all versions for each package
              const versionsResponse = await github.rest.packages.getAllPackageVersionsForPackageOwnedByOrg({
                org: org,
                package_type: packageType,
                package_name: packageName
              });

              // Filter versions that correspond to closed PRs and delete them
              for (const version of versionsResponse.data) {
                if (closedPrNumbers.includes(parseInt(version.name))) {
                  await github.rest.packages.deletePackageVersionForOrg({
                    org: org,
                    package_type: packageType,
                    package_name: packageName,
                    package_version_id: version.id,
                  });
                  console.log(`Deleted ${packageType} package version: ${version.id} corresponding to PR #${version.name}`);
                }
              }
            }
            
